#
# sample Makefile for Objective Caml
# Copyright (C) 2001 Jean-Christophe FILLIATRE
# 
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License version 2, as published by the Free Software Foundation.
# 
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# 
# See the GNU Library General Public License version 2 for more details
# (enclosed in the file LGPL).

# where to install the binaries
prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR=@bindir@

# where to install the man page
MANDIR=@mandir@

# other variables set by ./configure
OCAMLC   = @OCAMLC@
OCAMLOPT = @OCAMLOPT@
OCAMLDEP = @OCAMLDEP@
OCAMLLEX = @OCAMLLEX@
OCAMLYACC= @OCAMLYACC@
OCAMLLIB = @OCAMLLIB@
OCAMLBEST= @OCAMLBEST@
OCAMLVERSION = @OCAMLVERSION@
OCAMLWEB = @OCAMLWEB@
OCAMLWIN32 = @OCAMLWIN32@
EXE = @EXE@
OPAMBINDIR = @OPAMBINDIR@
OCAMLBUILD = @OCAMLBUILD@
OCAMLFIND = @OCAMLFIND@

INCLUDES =
BFLAGS =
OFLAGS =

######################################

# fjs_of_fml (from original Makefile)
SRC_DIR := src
OCAMLBUILDCMD  := $(OCAMLBUILD) -j 4 -classic-display -use-ocamlfind -Is $(SRC_DIR) -no-hygiene
STDLIB_DIR  := $(SRC_DIR)/stdlib_ml
TESTS_DIR  := $(SRC_DIR)/tests
EXECUTABLES := fjs_of_fml monad_ppx displayed_sources lineof assembly
OCAMLDEP := ocamldep
OCAMLDOT_DIR := $(SRC_DIR)/utils/ocamldot
OCAMLDOT := $(OCAMLDOT_DIR)/ocamldot

######################################

default: ocamlbuild byte stdlib
all: ocamlbuild byte native stdlib
byte:   $(addsuffix .byte,$(EXECUTABLES))
native: $(addsuffix .native,$(EXECUTABLES))

test: byte stdlib
	$(MAKE) -C $(TESTS_DIR) test

stdlib:
	$(MAKE) -C $(STDLIB_DIR)

ocamlbuild :
	eval $$(opam env)

# Rules
%.native: FORCE
	$(OCAMLBUILDCMD) $@

%.byte: FORCE
	$(OCAMLBUILDCMD) $@

# Debug
debug:  $(addsuffix .d.byte,$(EXECUTABLES)) .ocamldebug

.ocamldebug: _tags
	grep -o "package([^)]*)" _tags | sed "s/package(\([^)]*\))/\1/" | xargs $(OCAMLFIND) query -recursive | sed "s/^/directory /" > .ocamldebug

# Archi
ocamldot :
	$(MAKE) -C $(OCAMLDOT_DIR)

archi : ocamldot
	$(OCAMLDEP) *.ml > .depend
	cat .depend | $(OCAMLDOT) | dot -Tpdf > archi_generator.pdf

clean:
	$(OCAMLBUILD) -clean
	bash -c "rm -f .ocamldebug .depend archi_generator.pdf"
	$(MAKE) -C $(STDLIB_DIR) clean
	$(MAKE) -C $(OCAMLDOT_DIR) clean
	$(MAKE) -C $(TESTS_DIR) clean

.PHONY: default all byte native stdlib debug clean

FORCE: # Force rebuilds of OCaml targets via ocamlbuild, the FORCE file must not exist.
.NOTPARALLEL: # Only one ocamlbuild can be run at a time
